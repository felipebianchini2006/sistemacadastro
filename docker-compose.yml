x-app-env: &app-env
  NODE_ENV: production
  PORT: 3001
  DATABASE_URL: ${DATABASE_URL:-postgresql://sistemacadastro:123456@postgres:5432/sistemacadastro}
  REDIS_URL: ${REDIS_URL:-redis://redis:6379}
  JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-changeme-access-secret}
  JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-changeme-refresh-secret}
  DATA_ENCRYPTION_KEY: ${DATA_ENCRYPTION_KEY:-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=}
  CLICKSIGN_ACCESS_TOKEN: ${CLICKSIGN_ACCESS_TOKEN:-changeme12345}
  CLICKSIGN_BASE_URL: ${CLICKSIGN_BASE_URL:-https://sandbox.clicksign.com}
  CLICKSIGN_WEBHOOK_SECRET: ${CLICKSIGN_WEBHOOK_SECRET:-changeme}
  CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
  CORS_ALLOW_CREDENTIALS: ${CORS_ALLOW_CREDENTIALS:-true}
  CSRF_ENABLED: ${CSRF_ENABLED:-true}
  CSRF_COOKIE_NAME: ${CSRF_COOKIE_NAME:-csrf_token}
  CSRF_HEADER_NAME: ${CSRF_HEADER_NAME:-x-csrf-token}
  S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
  S3_PUBLIC_ENDPOINT: ${S3_PUBLIC_ENDPOINT:-http://localhost:9000}
  S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minio}
  S3_SECRET_KEY: ${S3_SECRET_KEY:-minio123}
  S3_BUCKET: ${S3_BUCKET:-sistemacadastro}
  S3_REGION: ${S3_REGION:-us-east-1}
  S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}
  UPLOAD_PRESIGN_TTL_SECONDS: ${UPLOAD_PRESIGN_TTL_SECONDS:-300}
  UPLOAD_MAX_SIZE_MB: ${UPLOAD_MAX_SIZE_MB:-10}
  UPLOAD_MIN_WIDTH: ${UPLOAD_MIN_WIDTH:-600}
  UPLOAD_MIN_HEIGHT: ${UPLOAD_MIN_HEIGHT:-600}
  CONSENT_VERSION: ${CONSENT_VERSION:-v1}
  PRIVACY_POLICY_VERSION: ${PRIVACY_POLICY_VERSION:-v1}
  RETENTION_DAYS_DRAFTS: ${RETENTION_DAYS_DRAFTS:-7}
  RETENTION_DAYS_AUDIT_LOGS: ${RETENTION_DAYS_AUDIT_LOGS:-365}
  RETENTION_DAYS_NOTIFICATIONS: ${RETENTION_DAYS_NOTIFICATIONS:-180}
  RETENTION_DAYS_DOCUMENTS: ${RETENTION_DAYS_DOCUMENTS:-365}
  BACKUP_CRON: ${BACKUP_CRON:-0 3 * * *}
  SENDGRID_FROM: ${SENDGRID_FROM:-no-reply@sistemacadastro.local}
  TWILIO_FROM: ${TWILIO_FROM:-+15555555555}
  PUBLIC_TRACKING_BASE_URL: ${PUBLIC_TRACKING_BASE_URL:-http://localhost:3000/acompanhar}
  PUBLIC_CADASTRO_BASE_URL: ${PUBLIC_CADASTRO_BASE_URL:-http://localhost:3000/cadastro}
  SOCIAL_OAUTH_STATE_SECRET: ${SOCIAL_OAUTH_STATE_SECRET:-changeme-social-secret}
  SOCIAL_REDIRECT_SUCCESS_URL: ${SOCIAL_REDIRECT_SUCCESS_URL:-http://localhost:3000/acompanhar}
  SOCIAL_REDIRECT_ERROR_URL: ${SOCIAL_REDIRECT_ERROR_URL:-http://localhost:3000/acompanhar}
  SOCIAL_REDIRECT_DRAFT_SUCCESS_URL: ${SOCIAL_REDIRECT_DRAFT_SUCCESS_URL:-http://localhost:3000/cadastro}
  SOCIAL_REDIRECT_DRAFT_ERROR_URL: ${SOCIAL_REDIRECT_DRAFT_ERROR_URL:-http://localhost:3000/cadastro}

x-runtime-security: &runtime-security
  init: true
  security_opt:
    - no-new-privileges:true

x-runtime-logging: &runtime-logging
  logging:
    driver: json-file
    options:
      max-size: '10m'
      max-file: '3'

services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-sistemacadastro}
      POSTGRES_USER: ${POSTGRES_USER:-sistemacadastro}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-123456}
    ports:
      - '127.0.0.1:${POSTGRES_PORT:-5432}:5432'
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U ${POSTGRES_USER:-sistemacadastro} -d ${POSTGRES_DB:-sistemacadastro}',
        ]
      interval: 10s
      timeout: 5s
      retries: 6

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - '127.0.0.1:${REDIS_PORT:-6379}:6379'
    networks:
      - backend
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 6

  minio:
    image: minio/minio:latest
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
      # Global CORS on MinIO API (avoids bucket-level CORS calls via `mc cors set`)
      MINIO_API_CORS_ALLOW_ORIGIN: ${MINIO_API_CORS_ALLOW_ORIGIN:-*}
    command: server /data --console-address ":9001"
    ports:
      - '${MINIO_PORT:-9000}:9000'
      - '127.0.0.1:${MINIO_CONSOLE_PORT:-9001}:9001'
    volumes:
      - minio-data:/data
    networks:
      - backend

  # ✅ CORREÇÃO: minio-init agora espera o MinIO ficar pronto (loop),
  # fixa a versão do mc e usa formato de CORS mais compatível (array JSON).
  minio-init:
    image: minio/mc:RELEASE.2024-10-29T15-34-59Z
    restart: 'no'
    depends_on:
      minio:
        condition: service_started
    entrypoint:
      - /bin/sh
      - -lc
      - |
        set -e

        echo ">> Waiting MinIO to be ready..."
        until mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minio} ${MINIO_ROOT_PASSWORD:-minio123} >/dev/null 2>&1; do
          sleep 2
        done

        echo ">> Ensuring bucket exists..."
        mc mb -p local/${S3_BUCKET:-sistemacadastro} || true

        echo ">> MinIO init done."
    networks:
      - backend

  api:
    <<: [*runtime-security, *runtime-logging]
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      <<: *app-env
      PORT: 3001
    ports:
      - '${API_PORT:-3001}:3001'
    networks:
      - backend
      - frontend
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://127.0.0.1:3001/health').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

  web:
    <<: [*runtime-security, *runtime-logging]
    build:
      context: .
      dockerfile: Dockerfile
      target: web
      args:
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:3001}
        NEXT_PUBLIC_CONSENT_VERSION: ${NEXT_PUBLIC_CONSENT_VERSION:-v1}
        NEXT_PUBLIC_PRIVACY_VERSION: ${NEXT_PUBLIC_PRIVACY_VERSION:-v1}
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:3001}
      NEXT_PUBLIC_CONSENT_VERSION: ${NEXT_PUBLIC_CONSENT_VERSION:-v1}
      NEXT_PUBLIC_PRIVACY_VERSION: ${NEXT_PUBLIC_PRIVACY_VERSION:-v1}
    ports:
      - '${WEB_PORT:-3000}:3000'
    networks:
      - frontend
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://127.0.0.1:3000').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 40s

  worker:
    <<: [*runtime-security, *runtime-logging]
    build:
      context: .
      dockerfile: Dockerfile
      target: worker
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      <<: *app-env
      PORT: 3001
    networks:
      - backend

volumes:
  pgdata:
  minio-data:

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true
